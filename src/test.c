
#include <wchar.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <unistd.h>

#include "test.h"
#include "input.h"

int fwprintf( FILE * stream, const wchar_t * format, ...);

int read_pipe_end;
int write_pipe_end;

static void pipe_setup( void * data, size_t data_sz ) {
	int pipes[2];
	int status = pipe( pipes );
	read_pipe_end = pipes[0];
	write_pipe_end = pipes[1];
	if( status == -1 ) fwprintf(stderr, L"pipe: %s\n", strerror(errno) );

	set_input( read_pipe_end );
	
	if( !(status = fork()) ) {
		status = close( read_pipe_end );
		if( status == -1 ) fwprintf(stderr, L"pipe close read for test %s: %s\n", __func__, strerror(errno) );
		status = write( write_pipe_end, data, data_sz );
		if( status == -1 ) fwprintf(stderr, L"pipe write for test %s: %s\n", __func__, strerror(errno) );
		exit(0);
	} 

	input_initialize();
}

static void pipe_teardown() {
	int status;

	// read_pipe_end will be closed by input_destroy()
	
	status = close( write_pipe_end );
	if( status == -1 ) fwprintf(stderr, L"close write pipe: %s\n", strerror(errno) );

	input_destroy();
}

char short_ascii[] = {
"\x48\x65\x6c\x6c\x6f\x0a"                                         /* Hello.           */
};

char short_utf16le[] = {
"\xff\xfe\x48\x00\x65\x00\x6c\x00\x6c\x00\x6f\x00\x0a\x00"         /* ..H.e.l.l.o...   */
};

char header_utf16le[] = {
"\xff\xfe\x4e\x00\x61\x00\x6d\x00\x65\x00\x2c\x00\x47\x00\x69\x00" /* ..N.a.m.e.,.G.i. */
"\x76\x00\x65\x00\x6e\x00\x20\x00\x4e\x00\x61\x00\x6d\x00\x65\x00" /* v.e.n. .N.a.m.e. */
"\x2c\x00\x41\x00\x64\x00\x64\x00\x69\x00\x74\x00\x69\x00\x6f\x00" /* ,.A.d.d.i.t.i.o. */
"\x6e\x00\x61\x00\x6c\x00\x20\x00\x4e\x00\x61\x00\x6d\x00\x65\x00" /* n.a.l. .N.a.m.e. */
"\x2c\x00\x46\x00\x61\x00\x6d\x00\x69\x00\x6c\x00\x79\x00\x20\x00" /* ,.F.a.m.i.l.y. . */
"\x4e\x00\x61\x00\x6d\x00\x65\x00\x2c\x00\x59\x00\x6f\x00\x6d\x00" /* N.a.m.e.,.Y.o.m. */
"\x69\x00\x20\x00\x4e\x00\x61\x00\x6d\x00\x65\x00\x2c\x00\x47\x00" /* i. .N.a.m.e.,.G. */
"\x69\x00\x76\x00\x65\x00\x6e\x00\x20\x00\x4e\x00\x61\x00\x6d\x00" /* i.v.e.n. .N.a.m. */
"\x65\x00\x20\x00\x59\x00\x6f\x00\x6d\x00\x69\x00\x2c\x00\x41\x00" /* e. .Y.o.m.i.,.A. */
"\x64\x00\x64\x00\x69\x00\x74\x00\x69\x00\x6f\x00\x6e\x00\x61\x00" /* d.d.i.t.i.o.n.a. */
"\x6c\x00\x20\x00\x4e\x00\x61\x00\x6d\x00\x65\x00\x20\x00\x59\x00" /* l. .N.a.m.e. .Y. */
"\x6f\x00\x6d\x00\x69\x00\x2c\x00\x46\x00\x61\x00\x6d\x00\x69\x00" /* o.m.i.,.F.a.m.i. */
"\x6c\x00\x79\x00\x20\x00\x4e\x00\x61\x00\x6d\x00\x65\x00\x20\x00" /* l.y. .N.a.m.e. . */
"\x59\x00\x6f\x00\x6d\x00\x69\x00\x2c\x00\x4e\x00\x61\x00\x6d\x00" /* Y.o.m.i.,.N.a.m. */
"\x65\x00\x20\x00\x50\x00\x72\x00\x65\x00\x66\x00\x69\x00\x78\x00" /* e. .P.r.e.f.i.x. */
"\x2c\x00\x4e\x00\x61\x00\x6d\x00\x65\x00\x20\x00\x53\x00\x75\x00" /* ,.N.a.m.e. .S.u. */
"\x66\x00\x66\x00\x69\x00\x78\x00\x2c\x00\x49\x00\x6e\x00\x69\x00" /* f.f.i.x.,.I.n.i. */
"\x74\x00\x69\x00\x61\x00\x6c\x00\x73\x00\x2c\x00\x4e\x00\x69\x00" /* t.i.a.l.s.,.N.i. */
"\x63\x00\x6b\x00\x6e\x00\x61\x00\x6d\x00\x65\x00\x2c\x00\x53\x00" /* c.k.n.a.m.e.,.S. */
"\x68\x00\x6f\x00\x72\x00\x74\x00\x20\x00\x4e\x00\x61\x00\x6d\x00" /* h.o.r.t. .N.a.m. */
"\x65\x00\x2c\x00\x4d\x00\x61\x00\x69\x00\x64\x00\x65\x00\x6e\x00" /* e.,.M.a.i.d.e.n. */
"\x20\x00\x4e\x00\x61\x00\x6d\x00\x65\x00\x2c\x00\x42\x00\x69\x00" /*  .N.a.m.e.,.B.i. */
"\x72\x00\x74\x00\x68\x00\x64\x00\x61\x00\x79\x00\x2c\x00\x47\x00" /* r.t.h.d.a.y.,.G. */
"\x65\x00\x6e\x00\x64\x00\x65\x00\x72\x00\x2c\x00\x4c\x00\x6f\x00" /* e.n.d.e.r.,.L.o. */
"\x63\x00\x61\x00\x74\x00\x69\x00\x6f\x00\x6e\x00\x2c\x00\x42\x00" /* c.a.t.i.o.n.,.B. */
"\x69\x00\x6c\x00\x6c\x00\x69\x00\x6e\x00\x67\x00\x20\x00\x49\x00" /* i.l.l.i.n.g. .I. */
"\x6e\x00\x66\x00\x6f\x00\x72\x00\x6d\x00\x61\x00\x74\x00\x69\x00" /* n.f.o.r.m.a.t.i. */
"\x6f\x00\x6e\x00\x2c\x00\x44\x00\x69\x00\x72\x00\x65\x00\x63\x00" /* o.n.,.D.i.r.e.c. */
"\x74\x00\x6f\x00\x72\x00\x79\x00\x20\x00\x53\x00\x65\x00\x72\x00" /* t.o.r.y. .S.e.r. */
"\x76\x00\x65\x00\x72\x00\x2c\x00\x4d\x00\x69\x00\x6c\x00\x65\x00" /* v.e.r.,.M.i.l.e. */
"\x61\x00\x67\x00\x65\x00\x2c\x00\x4f\x00\x63\x00\x63\x00\x75\x00" /* a.g.e.,.O.c.c.u. */
"\x70\x00\x61\x00\x74\x00\x69\x00\x6f\x00\x6e\x00\x2c\x00\x48\x00" /* p.a.t.i.o.n.,.H. */
"\x6f\x00\x62\x00\x62\x00\x79\x00\x2c\x00\x53\x00\x65\x00\x6e\x00" /* o.b.b.y.,.S.e.n. */
"\x73\x00\x69\x00\x74\x00\x69\x00\x76\x00\x69\x00\x74\x00\x79\x00" /* s.i.t.i.v.i.t.y. */
"\x2c\x00\x50\x00\x72\x00\x69\x00\x6f\x00\x72\x00\x69\x00\x74\x00" /* ,.P.r.i.o.r.i.t. */
"\x79\x00\x2c\x00\x53\x00\x75\x00\x62\x00\x6a\x00\x65\x00\x63\x00" /* y.,.S.u.b.j.e.c. */
"\x74\x00\x2c\x00\x4e\x00\x6f\x00\x74\x00\x65\x00\x73\x00\x2c\x00" /* t.,.N.o.t.e.s.,. */
"\x47\x00\x72\x00\x6f\x00\x75\x00\x70\x00\x20\x00\x4d\x00\x65\x00" /* G.r.o.u.p. .M.e. */
"\x6d\x00\x62\x00\x65\x00\x72\x00\x73\x00\x68\x00\x69\x00\x70\x00" /* m.b.e.r.s.h.i.p. */
"\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00\x69\x00\x6c\x00\x20\x00" /* ,.E.-.m.a.i.l. . */
"\x31\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00\x70\x00\x65\x00" /* 1. .-. .T.y.p.e. */
"\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00\x69\x00\x6c\x00\x20\x00" /* ,.E.-.m.a.i.l. . */
"\x31\x00\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00\x75\x00" /* 1. .-. .V.a.l.u. */
"\x65\x00\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00\x69\x00\x6c\x00" /* e.,.E.-.m.a.i.l. */
"\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00\x70\x00" /*  .2. .-. .T.y.p. */
"\x65\x00\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00\x69\x00\x6c\x00" /* e.,.E.-.m.a.i.l. */
"\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00" /*  .2. .-. .V.a.l. */
"\x75\x00\x65\x00\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00\x69\x00" /* u.e.,.E.-.m.a.i. */
"\x6c\x00\x20\x00\x33\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00" /* l. .3. .-. .T.y. */
"\x70\x00\x65\x00\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00\x69\x00" /* p.e.,.E.-.m.a.i. */
"\x6c\x00\x20\x00\x33\x00\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00" /* l. .3. .-. .V.a. */
"\x6c\x00\x75\x00\x65\x00\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00" /* l.u.e.,.E.-.m.a. */
"\x69\x00\x6c\x00\x20\x00\x34\x00\x20\x00\x2d\x00\x20\x00\x54\x00" /* i.l. .4. .-. .T. */
"\x79\x00\x70\x00\x65\x00\x2c\x00\x45\x00\x2d\x00\x6d\x00\x61\x00" /* y.p.e.,.E.-.m.a. */
"\x69\x00\x6c\x00\x20\x00\x34\x00\x20\x00\x2d\x00\x20\x00\x56\x00" /* i.l. .4. .-. .V. */
"\x61\x00\x6c\x00\x75\x00\x65\x00\x2c\x00\x50\x00\x68\x00\x6f\x00" /* a.l.u.e.,.P.h.o. */
"\x6e\x00\x65\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x54\x00" /* n.e. .1. .-. .T. */
"\x79\x00\x70\x00\x65\x00\x2c\x00\x50\x00\x68\x00\x6f\x00\x6e\x00" /* y.p.e.,.P.h.o.n. */
"\x65\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00" /* e. .1. .-. .V.a. */
"\x6c\x00\x75\x00\x65\x00\x2c\x00\x50\x00\x68\x00\x6f\x00\x6e\x00" /* l.u.e.,.P.h.o.n. */
"\x65\x00\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00" /* e. .2. .-. .T.y. */
"\x70\x00\x65\x00\x2c\x00\x50\x00\x68\x00\x6f\x00\x6e\x00\x65\x00" /* p.e.,.P.h.o.n.e. */
"\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00" /*  .2. .-. .V.a.l. */
"\x75\x00\x65\x00\x2c\x00\x50\x00\x68\x00\x6f\x00\x6e\x00\x65\x00" /* u.e.,.P.h.o.n.e. */
"\x20\x00\x33\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00\x70\x00" /*  .3. .-. .T.y.p. */
"\x65\x00\x2c\x00\x50\x00\x68\x00\x6f\x00\x6e\x00\x65\x00\x20\x00" /* e.,.P.h.o.n.e. . */
"\x33\x00\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00\x75\x00" /* 3. .-. .V.a.l.u. */
"\x65\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00\x73\x00" /* e.,.A.d.d.r.e.s. */
"\x73\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00" /* s. .1. .-. .T.y. */
"\x70\x00\x65\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00" /* p.e.,.A.d.d.r.e. */
"\x73\x00\x73\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x46\x00" /* s.s. .1. .-. .F. */
"\x6f\x00\x72\x00\x6d\x00\x61\x00\x74\x00\x74\x00\x65\x00\x64\x00" /* o.r.m.a.t.t.e.d. */
"\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00\x73\x00\x73\x00" /* ,.A.d.d.r.e.s.s. */
"\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x53\x00\x74\x00\x72\x00" /*  .1. .-. .S.t.r. */
"\x65\x00\x65\x00\x74\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00" /* e.e.t.,.A.d.d.r. */
"\x65\x00\x73\x00\x73\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00" /* e.s.s. .1. .-. . */
"\x43\x00\x69\x00\x74\x00\x79\x00\x2c\x00\x41\x00\x64\x00\x64\x00" /* C.i.t.y.,.A.d.d. */
"\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00\x31\x00\x20\x00\x2d\x00" /* r.e.s.s. .1. .-. */
"\x20\x00\x50\x00\x4f\x00\x20\x00\x42\x00\x6f\x00\x78\x00\x2c\x00" /*  .P.O. .B.o.x.,. */
"\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00" /* A.d.d.r.e.s.s. . */
"\x31\x00\x20\x00\x2d\x00\x20\x00\x52\x00\x65\x00\x67\x00\x69\x00" /* 1. .-. .R.e.g.i. */
"\x6f\x00\x6e\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00" /* o.n.,.A.d.d.r.e. */
"\x73\x00\x73\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x50\x00" /* s.s. .1. .-. .P. */
"\x6f\x00\x73\x00\x74\x00\x61\x00\x6c\x00\x20\x00\x43\x00\x6f\x00" /* o.s.t.a.l. .C.o. */
"\x64\x00\x65\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00" /* d.e.,.A.d.d.r.e. */
"\x73\x00\x73\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x43\x00" /* s.s. .1. .-. .C. */
"\x6f\x00\x75\x00\x6e\x00\x74\x00\x72\x00\x79\x00\x2c\x00\x41\x00" /* o.u.n.t.r.y.,.A. */
"\x64\x00\x64\x00\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00\x31\x00" /* d.d.r.e.s.s. .1. */
"\x20\x00\x2d\x00\x20\x00\x45\x00\x78\x00\x74\x00\x65\x00\x6e\x00" /*  .-. .E.x.t.e.n. */
"\x64\x00\x65\x00\x64\x00\x20\x00\x41\x00\x64\x00\x64\x00\x72\x00" /* d.e.d. .A.d.d.r. */
"\x65\x00\x73\x00\x73\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00" /* e.s.s.,.A.d.d.r. */
"\x65\x00\x73\x00\x73\x00\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00" /* e.s.s. .2. .-. . */
"\x54\x00\x79\x00\x70\x00\x65\x00\x2c\x00\x41\x00\x64\x00\x64\x00" /* T.y.p.e.,.A.d.d. */
"\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00\x32\x00\x20\x00\x2d\x00" /* r.e.s.s. .2. .-. */
"\x20\x00\x46\x00\x6f\x00\x72\x00\x6d\x00\x61\x00\x74\x00\x74\x00" /*  .F.o.r.m.a.t.t. */
"\x65\x00\x64\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00" /* e.d.,.A.d.d.r.e. */
"\x73\x00\x73\x00\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x53\x00" /* s.s. .2. .-. .S. */
"\x74\x00\x72\x00\x65\x00\x65\x00\x74\x00\x2c\x00\x41\x00\x64\x00" /* t.r.e.e.t.,.A.d. */
"\x64\x00\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00\x32\x00\x20\x00" /* d.r.e.s.s. .2. . */
"\x2d\x00\x20\x00\x43\x00\x69\x00\x74\x00\x79\x00\x2c\x00\x41\x00" /* -. .C.i.t.y.,.A. */
"\x64\x00\x64\x00\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00\x32\x00" /* d.d.r.e.s.s. .2. */
"\x20\x00\x2d\x00\x20\x00\x50\x00\x4f\x00\x20\x00\x42\x00\x6f\x00" /*  .-. .P.O. .B.o. */
"\x78\x00\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00\x73\x00" /* x.,.A.d.d.r.e.s. */
"\x73\x00\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x52\x00\x65\x00" /* s. .2. .-. .R.e. */
"\x67\x00\x69\x00\x6f\x00\x6e\x00\x2c\x00\x41\x00\x64\x00\x64\x00" /* g.i.o.n.,.A.d.d. */
"\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00\x32\x00\x20\x00\x2d\x00" /* r.e.s.s. .2. .-. */
"\x20\x00\x50\x00\x6f\x00\x73\x00\x74\x00\x61\x00\x6c\x00\x20\x00" /*  .P.o.s.t.a.l. . */
"\x43\x00\x6f\x00\x64\x00\x65\x00\x2c\x00\x41\x00\x64\x00\x64\x00" /* C.o.d.e.,.A.d.d. */
"\x72\x00\x65\x00\x73\x00\x73\x00\x20\x00\x32\x00\x20\x00\x2d\x00" /* r.e.s.s. .2. .-. */
"\x20\x00\x43\x00\x6f\x00\x75\x00\x6e\x00\x74\x00\x72\x00\x79\x00" /*  .C.o.u.n.t.r.y. */
"\x2c\x00\x41\x00\x64\x00\x64\x00\x72\x00\x65\x00\x73\x00\x73\x00" /* ,.A.d.d.r.e.s.s. */
"\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x45\x00\x78\x00\x74\x00" /*  .2. .-. .E.x.t. */
"\x65\x00\x6e\x00\x64\x00\x65\x00\x64\x00\x20\x00\x41\x00\x64\x00" /* e.n.d.e.d. .A.d. */
"\x64\x00\x72\x00\x65\x00\x73\x00\x73\x00\x2c\x00\x4f\x00\x72\x00" /* d.r.e.s.s.,.O.r. */
"\x67\x00\x61\x00\x6e\x00\x69\x00\x7a\x00\x61\x00\x74\x00\x69\x00" /* g.a.n.i.z.a.t.i. */
"\x6f\x00\x6e\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x54\x00" /* o.n. .1. .-. .T. */
"\x79\x00\x70\x00\x65\x00\x2c\x00\x4f\x00\x72\x00\x67\x00\x61\x00" /* y.p.e.,.O.r.g.a. */
"\x6e\x00\x69\x00\x7a\x00\x61\x00\x74\x00\x69\x00\x6f\x00\x6e\x00" /* n.i.z.a.t.i.o.n. */
"\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x4e\x00\x61\x00\x6d\x00" /*  .1. .-. .N.a.m. */
"\x65\x00\x2c\x00\x4f\x00\x72\x00\x67\x00\x61\x00\x6e\x00\x69\x00" /* e.,.O.r.g.a.n.i. */
"\x7a\x00\x61\x00\x74\x00\x69\x00\x6f\x00\x6e\x00\x20\x00\x31\x00" /* z.a.t.i.o.n. .1. */
"\x20\x00\x2d\x00\x20\x00\x59\x00\x6f\x00\x6d\x00\x69\x00\x20\x00" /*  .-. .Y.o.m.i. . */
"\x4e\x00\x61\x00\x6d\x00\x65\x00\x2c\x00\x4f\x00\x72\x00\x67\x00" /* N.a.m.e.,.O.r.g. */
"\x61\x00\x6e\x00\x69\x00\x7a\x00\x61\x00\x74\x00\x69\x00\x6f\x00" /* a.n.i.z.a.t.i.o. */
"\x6e\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x69\x00" /* n. .1. .-. .T.i. */
"\x74\x00\x6c\x00\x65\x00\x2c\x00\x4f\x00\x72\x00\x67\x00\x61\x00" /* t.l.e.,.O.r.g.a. */
"\x6e\x00\x69\x00\x7a\x00\x61\x00\x74\x00\x69\x00\x6f\x00\x6e\x00" /* n.i.z.a.t.i.o.n. */
"\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x44\x00\x65\x00\x70\x00" /*  .1. .-. .D.e.p. */
"\x61\x00\x72\x00\x74\x00\x6d\x00\x65\x00\x6e\x00\x74\x00\x2c\x00" /* a.r.t.m.e.n.t.,. */
"\x4f\x00\x72\x00\x67\x00\x61\x00\x6e\x00\x69\x00\x7a\x00\x61\x00" /* O.r.g.a.n.i.z.a. */
"\x74\x00\x69\x00\x6f\x00\x6e\x00\x20\x00\x31\x00\x20\x00\x2d\x00" /* t.i.o.n. .1. .-. */
"\x20\x00\x53\x00\x79\x00\x6d\x00\x62\x00\x6f\x00\x6c\x00\x2c\x00" /*  .S.y.m.b.o.l.,. */
"\x4f\x00\x72\x00\x67\x00\x61\x00\x6e\x00\x69\x00\x7a\x00\x61\x00" /* O.r.g.a.n.i.z.a. */
"\x74\x00\x69\x00\x6f\x00\x6e\x00\x20\x00\x31\x00\x20\x00\x2d\x00" /* t.i.o.n. .1. .-. */
"\x20\x00\x4c\x00\x6f\x00\x63\x00\x61\x00\x74\x00\x69\x00\x6f\x00" /*  .L.o.c.a.t.i.o. */
"\x6e\x00\x2c\x00\x4f\x00\x72\x00\x67\x00\x61\x00\x6e\x00\x69\x00" /* n.,.O.r.g.a.n.i. */
"\x7a\x00\x61\x00\x74\x00\x69\x00\x6f\x00\x6e\x00\x20\x00\x31\x00" /* z.a.t.i.o.n. .1. */
"\x20\x00\x2d\x00\x20\x00\x4a\x00\x6f\x00\x62\x00\x20\x00\x44\x00" /*  .-. .J.o.b. .D. */
"\x65\x00\x73\x00\x63\x00\x72\x00\x69\x00\x70\x00\x74\x00\x69\x00" /* e.s.c.r.i.p.t.i. */
"\x6f\x00\x6e\x00\x2c\x00\x52\x00\x65\x00\x6c\x00\x61\x00\x74\x00" /* o.n.,.R.e.l.a.t. */
"\x69\x00\x6f\x00\x6e\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00" /* i.o.n. .1. .-. . */
"\x54\x00\x79\x00\x70\x00\x65\x00\x2c\x00\x52\x00\x65\x00\x6c\x00" /* T.y.p.e.,.R.e.l. */
"\x61\x00\x74\x00\x69\x00\x6f\x00\x6e\x00\x20\x00\x31\x00\x20\x00" /* a.t.i.o.n. .1. . */
"\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00\x75\x00\x65\x00\x2c\x00" /* -. .V.a.l.u.e.,. */
"\x57\x00\x65\x00\x62\x00\x73\x00\x69\x00\x74\x00\x65\x00\x20\x00" /* W.e.b.s.i.t.e. . */
"\x31\x00\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00\x70\x00\x65\x00" /* 1. .-. .T.y.p.e. */
"\x2c\x00\x57\x00\x65\x00\x62\x00\x73\x00\x69\x00\x74\x00\x65\x00" /* ,.W.e.b.s.i.t.e. */
"\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00" /*  .1. .-. .V.a.l. */
"\x75\x00\x65\x00\x2c\x00\x57\x00\x65\x00\x62\x00\x73\x00\x69\x00" /* u.e.,.W.e.b.s.i. */
"\x74\x00\x65\x00\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00\x54\x00" /* t.e. .2. .-. .T. */
"\x79\x00\x70\x00\x65\x00\x2c\x00\x57\x00\x65\x00\x62\x00\x73\x00" /* y.p.e.,.W.e.b.s. */
"\x69\x00\x74\x00\x65\x00\x20\x00\x32\x00\x20\x00\x2d\x00\x20\x00" /* i.t.e. .2. .-. . */
"\x56\x00\x61\x00\x6c\x00\x75\x00\x65\x00\x2c\x00\x57\x00\x65\x00" /* V.a.l.u.e.,.W.e. */
"\x62\x00\x73\x00\x69\x00\x74\x00\x65\x00\x20\x00\x33\x00\x20\x00" /* b.s.i.t.e. .3. . */
"\x2d\x00\x20\x00\x54\x00\x79\x00\x70\x00\x65\x00\x2c\x00\x57\x00" /* -. .T.y.p.e.,.W. */
"\x65\x00\x62\x00\x73\x00\x69\x00\x74\x00\x65\x00\x20\x00\x33\x00" /* e.b.s.i.t.e. .3. */
"\x20\x00\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00\x75\x00\x65\x00" /*  .-. .V.a.l.u.e. */
"\x2c\x00\x45\x00\x76\x00\x65\x00\x6e\x00\x74\x00\x20\x00\x31\x00" /* ,.E.v.e.n.t. .1. */
"\x20\x00\x2d\x00\x20\x00\x54\x00\x79\x00\x70\x00\x65\x00\x2c\x00" /*  .-. .T.y.p.e.,. */
"\x45\x00\x76\x00\x65\x00\x6e\x00\x74\x00\x20\x00\x31\x00\x20\x00" /* E.v.e.n.t. .1. . */
"\x2d\x00\x20\x00\x56\x00\x61\x00\x6c\x00\x75\x00\x65\x00\x2c\x00" /* -. .V.a.l.u.e.,. */
"\x43\x00\x75\x00\x73\x00\x74\x00\x6f\x00\x6d\x00\x20\x00\x46\x00" /* C.u.s.t.o.m. .F. */
"\x69\x00\x65\x00\x6c\x00\x64\x00\x20\x00\x31\x00\x20\x00\x2d\x00" /* i.e.l.d. .1. .-. */
"\x20\x00\x54\x00\x79\x00\x70\x00\x65\x00\x2c\x00\x43\x00\x75\x00" /*  .T.y.p.e.,.C.u. */
"\x73\x00\x74\x00\x6f\x00\x6d\x00\x20\x00\x46\x00\x69\x00\x65\x00" /* s.t.o.m. .F.i.e. */
"\x6c\x00\x64\x00\x20\x00\x31\x00\x20\x00\x2d\x00\x20\x00\x56\x00" /* l.d. .1. .-. .V. */
"\x61\x00\x6c\x00\x75\x00\x65\x00\x0d\x00\x0a"                     /* a.l.u.e....      */    
};

#define TEST_INIT \
	*testname = __func__;

static int test_short_ascii_char( const char ** testname ) {

	TEST_INIT

	/*
	int hasmore;
	wchar_t current;
	hasmore = has_more_wchars();
	current = get_current_char();
	hasmore = has_more_wchars();
	current = get_current_char();
	hasmore = has_more_wchars();
	current = get_current_char();
	hasmore = has_more_wchars();
	current = get_current_char();
	hasmore = has_more_wchars();
	current = get_current_char();

	return 0;
	*/

	return has_more_wchars()
		&& get_current_char() == L'H'
		&& has_more_wchars()
		&& get_current_char() == L'e'
		&& has_more_wchars()
		&& get_current_char() == L'l'
		&& has_more_wchars()
		&& get_current_char() == L'l'
		&& has_more_wchars()
		&& get_current_char() == L'o'
		&& !has_more_wchars();
		;
}

static int test_short_utf16le_char( const char ** testname ) {

	TEST_INIT

	return has_more_wchars()
		&& get_current_char() == L'H'
		&& has_more_wchars()
		&& get_current_char() == L'e'
		&& has_more_wchars()
		&& get_current_char() == L'l'
		&& has_more_wchars()
		&& get_current_char() == L'l'
		&& has_more_wchars()
		&& get_current_char() == L'o'
		&& !has_more_wchars();
		;
}


typedef void (*setup_func)( void * data, size_t data_sz );
typedef int (*run_test_func)( const char ** testname );
typedef void (*tear_down_func)();

struct test {
	setup_func setup;
	void * data;
	size_t data_sz;
	run_test_func run_test;
	tear_down_func tear_down;
};

static struct test tests[] = {
	{ pipe_setup, short_ascii, sizeof short_ascii, test_short_ascii_char, pipe_teardown },
	{ pipe_setup, short_utf16le, sizeof short_utf16le, test_short_utf16le_char, pipe_teardown },
	{ NULL }
};

void run_tests() {
	int test_count = 0;
	int passing_test_count = 0;

	struct test * one_test = tests;

	for(; one_test->setup ; one_test++ ) {
		test_count++;

		if(one_test->setup) 
			one_test->setup( one_test->data, one_test->data_sz );

		if( !one_test->run_test ) {
			fwprintf( stderr, L"Hmm, an empty test, skipping...\n");
			continue;
		}

		const char * testname;
		if(one_test->run_test( &testname )) {
			passing_test_count++;
		} else {
			fwprintf( stderr, L"Test failed: %s\n", testname );
		}

		if(one_test->tear_down) one_test->tear_down();
	}
	fwprintf(stderr, L"%d of %d test(s) passed\n", passing_test_count, test_count );
}



